version: 2.0
jobs:
  build:
    docker:
      - image: hashicorp/terraform:0.12.10
    steps:
      - checkout
      - run:
          command: |
            apk add --no-cache curl jq
            for keyEqualsValueString in $(curl -sSf \
            -H "Authorization:Bearer $HEROKU_API_KEY" \
            -H "Accept:application/vnd.heroku+json; version=3" \
            https://api.heroku.com/apps/departure-infra-backend/config-vars \
            | jq -r "to_entries|map(\"TF_VAR_\(.key|ascii_downcase)=\(.value|tostring)\")|.[]"); \
            do export $keyEqualsValueString; done
            echo 1 | terraform init -backend-config="conn_str=$TF_VAR_database_url"
            terraform plan -out=current.tfplan
            terraform apply current.tfplan
workflows:
  version: 2
  approval-and-build:
    jobs:
      - hold:
          filters:
            branches:
              only: master
          type: approval
      - build:
          requires:
            - hold
